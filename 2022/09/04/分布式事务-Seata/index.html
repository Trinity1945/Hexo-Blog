

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#857d85">
  <meta name="author" content="liziyuan">
  <meta name="keywords" content="">
  
    <meta name="description" content="分布式事务-Seata一、本地事务 在JavaEE企业级开发的应用领域，为了保证数据的完整性和一致性，必须引入数据库事务的概念，所以事务管理是企业级应用程序开发中必不可少的技术。 所谓本地事务，是指在单个数据源上进行数据的访问和更新，它仅在当前工程内有效。  1.1 ACID特性 数据库事务的四大特性：原子性(Atomicity )、一致性( Consistency )、隔离性或独立性( Isol">
<meta property="og:type" content="article">
<meta property="og:title" content="分布式事务">
<meta property="og:url" content="http://example.com/2022/09/04/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-Seata/index.html">
<meta property="og:site_name" content="九黎城">
<meta property="og:description" content="分布式事务-Seata一、本地事务 在JavaEE企业级开发的应用领域，为了保证数据的完整性和一致性，必须引入数据库事务的概念，所以事务管理是企业级应用程序开发中必不可少的技术。 所谓本地事务，是指在单个数据源上进行数据的访问和更新，它仅在当前工程内有效。  1.1 ACID特性 数据库事务的四大特性：原子性(Atomicity )、一致性( Consistency )、隔离性或独立性( Isol">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/15.jpg">
<meta property="article:published_time" content="2022-09-04T01:12:24.000Z">
<meta property="article:modified_time" content="2022-09-04T06:15:47.487Z">
<meta property="article:author" content="liziyuan">
<meta property="article:tag" content="事务">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/15.jpg">
  
  
  
  <title>分布式事务 - 九黎城</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>bigMouse</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                Links
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/2.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="分布式事务"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-09-04 09:12" pubdate>
          2022年9月4日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          16k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          133 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">分布式事务</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="分布式事务-Seata"><a href="#分布式事务-Seata" class="headerlink" title="分布式事务-Seata"></a>分布式事务-Seata</h1><h2 id="一、本地事务"><a href="#一、本地事务" class="headerlink" title="一、本地事务"></a>一、本地事务</h2><blockquote>
<p>在<code>JavaEE</code>企业级开发的应用领域，为了<strong>保证数据</strong>的<strong>完整性</strong>和<strong>一致性</strong>，必须引入数据库事务的概念，所以事务管理是企业级应用程序开发中必不可少的技术。</p>
<p>所谓<strong>本地事务</strong>，是指在单个数据源上进行数据的访问和更新，它<strong>仅在当前工程内有效</strong>。</p>
</blockquote>
<h3 id="1-1-ACID特性"><a href="#1-1-ACID特性" class="headerlink" title="1.1 ACID特性"></a>1.1 ACID特性</h3><ul>
<li>数据库事务的四大<strong>特性</strong>：原子性(<code>Atomicity</code> )、一致性( <code>Consistency</code> )、隔离性或独立性( <code>Isolation</code>) 和持久性(<code>Durabilily</code>)，简称就是 <code>ACID</code>。<ul>
<li><strong>原子性</strong>：一系列的操作整体不可拆分，要么同时成功，要么同时失败。</li>
<li><strong>一致性</strong>：数据在事务的前后，业务整体一致。</li>
<li><strong>隔离性</strong>：事务之间互相隔离。</li>
<li><strong>持久性</strong>：一旦事务成功，数据一定会落盘在数据库。</li>
</ul>
</li>
<li>在以往的单体应用中，我们多个业务操作使用同一条连接操作不同的数据表，一旦有异常，我们可以很容易地整体回滚。就比如买东西业务，扣库存，下订单，账户扣款，是一个整体，<strong>必须同时成功或者失败</strong>。一个事务开始，代表以下的<strong>所有操作</strong>都在<strong>同一个连接</strong>里面。</li>
</ul>
<h3 id="1-2-隔离级别"><a href="#1-2-隔离级别" class="headerlink" title="1.2 隔离级别"></a>1.2 隔离级别</h3><ul>
<li><code>READ UNCOMMITTED</code>（<strong>脏读</strong>）：该隔离级别的事务会<strong>读到其它未提交事</strong>务的数据。</li>
</ul>
<p><img src="https://picgo-liziyuan.oss-cn-hangzhou.aliyuncs.com/img202208082203395.webp" srcset="/img/loading.gif" lazyload alt="image-20220709182208960"></p>
<ul>
<li><code>READ COMMITTED</code>（<strong>不可重复读</strong>）：一个事务可以读取另一个已提交的事务，<strong>多次读取会造成不一样的结果</strong>。<code>Oracle</code> 和 <code>SQL Server</code> 的默认隔离级别。</li>
</ul>
<p><img src="https://picgo-liziyuan.oss-cn-hangzhou.aliyuncs.com/img202208082203393.webp" srcset="/img/loading.gif" lazyload alt="image-20220709183324143"></p>
<ul>
<li><code>REPEATABLE READ</code>（<strong>虚读&#x2F;幻读</strong>）：该隔离级别是 <code>MySQL</code> 默认的隔离级别，一个事务可以<strong>读取另一个事务已提交的数据</strong>，<strong>读取的数据前后相比多了点或者少了点</strong>。<code>MySQL</code> 的 <code>InnoDB</code> 引擎可以通过<code>next-key locks</code> 机制来避免<strong>幻读</strong>。</li>
</ul>
<p><img src="https://picgo-liziyuan.oss-cn-hangzhou.aliyuncs.com/img202208082203380.webp" srcset="/img/loading.gif" lazyload alt="image-20220709185135362"></p>
<ul>
<li><code>SERIALIZABLE</code>（<strong>序列化</strong>）：这是数据库<strong>最高的隔离级别</strong>，在该隔离级别下事务都是<strong>串行顺序执行</strong>的，<code>MySQL</code> 数据库的 <code>InnoDB</code> 引擎会给读操作隐式加一把读共享锁，从而避免了脏读、不可重读复读和幻读问题，但是<strong>执行效率差</strong>，性能开销也最大，所以基本没人会用。</li>
</ul>
<h3 id="1-3-事务的传播行为"><a href="#1-3-事务的传播行为" class="headerlink" title="1.3 事务的传播行为"></a>1.3 事务的传播行为</h3><ul>
<li><strong>PROPAGATION_REQUIRED</strong>： ：如果当前<strong>没有</strong>事务，就<strong>创建</strong>一个新事务，如果当前<strong>存在</strong>事务，就<strong>加入</strong>该事务，该设置是<strong>最常用的设置</strong>。</li>
<li>PROPAGATION_SUPPORTS： ：支持当前事务，如果当前存在事务，就加入该事务，如果当前不存在事务，就以非事务执行。</li>
<li>PROPAGATION_MANDATORY： ：支持当前事务，如果当前存在事务，就加入该事务，如果当前不存在事务，就抛出异常。</li>
<li><strong>PROPAGATION_REQUIRES_NEW</strong>：：创建新事务，<strong>无论当前存不存在事务，都创建新事务</strong>。</li>
<li>PROPAGATION_NOT_SUPPORTED：：以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。</li>
<li>PROPAGATION_NEVER： ：以非事务方式执行，如果当前存在事务，则抛出异常。</li>
<li>PROPAGATION_NESTED： ：如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则执行与 PROPAGATION_REQUIRED 类似的操作。</li>
<li>七种事务传播机制<strong>最常用</strong>的就<strong>两种</strong>：<ul>
<li>REQUIRED：一个事务，要么成功，要么失败。</li>
<li>REQUIRES_NEW：两个不同事务，彼此之间没有关系。一个事务失败了不影响另一个事务。</li>
</ul>
</li>
</ul>
<h3 id="1-4-本地事务在分布式下的问题"><a href="#1-4-本地事务在分布式下的问题" class="headerlink" title="1.4 本地事务在分布式下的问题"></a>1.4 本地事务在分布式下的问题</h3><p><strong>1.4.1 问题一：远程服务假失败</strong></p>
<ul>
<li>远程服务其实成功了，由于网络故障没有返回，导致订单回滚，库存却扣减。</li>
<li>假失败就是我们在订单服务调库存服务时， <strong>库存锁定成功</strong>，然后由于<strong>服务器</strong>慢、卡顿、等<strong>故障</strong>原因，本地事务提交了之后，<strong>一直没返回</strong>到订单服务。此时再看订单服务，因为调用库存服务时间太长了，库存服务迟迟没有返回结果，可能就会<strong>触发</strong> <code>feign</code> 的<strong>超时机制</strong>，在调用远程服务这里<strong>抛异常</strong>：<code>read time out</code> 读取超时，但是这个异常并不是我们手动抛的锁库存异常，而是 <code>feign</code> 的异常并且订单服务，设计的回滚机制，是只要<strong>一出现异常就会全部回滚</strong>，导致最终<strong>数据不一致</strong>。</li>
<li><strong>示意图</strong>：</li>
</ul>
<p><img src="https://picgo-liziyuan.oss-cn-hangzhou.aliyuncs.com/img202208082203380.webp" srcset="/img/loading.gif" lazyload alt="image-20220709064805120"></p>
<p><strong>1.4.2 问题二：调用新服务出现异常之后，已经执行的服务不会回滚</strong></p>
<ul>
<li>假设库存锁定成功，将结果返回到了订单服务，我们根据结果又调用了积分服务，让它扣减积分，结果<strong>积分服务</strong>内部出现<strong>异常</strong>，积分数据回滚此时再看订单服务，<strong>订单服务感知到</strong>我们手动抛的<strong>积分异常</strong>，订单数据回滚，但是<strong>库存服务</strong>，却<strong>不会有任何感知</strong>。其结果就是<strong>积分、订单数据全部回滚，库存给锁定了</strong>，也是<strong>数据不一致</strong>。</li>
<li><strong>示意图</strong>：</li>
</ul>
<p><img src="https://picgo-liziyuan.oss-cn-hangzhou.aliyuncs.com/img202208082203387.webp" srcset="/img/loading.gif" lazyload alt="image-20220709064934354"></p>
<p><strong>1.4.3 总结</strong>：</p>
<ul>
<li><strong>本地事务</strong>，在分布式系统，<strong>只能控制住自己的回滚</strong>，控制不了其它服务的回滚。</li>
<li>产生<strong>分布式事务问题</strong>的最大原因，就是<strong>网络问题</strong> + <strong>分布式机器</strong>。</li>
</ul>
<h2 id="二、分布式事务"><a href="#二、分布式事务" class="headerlink" title="二、分布式事务"></a>二、分布式事务</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">假设我们有一个下单的事务场景，它会涉及调用库存、订单、会员功能。<br>复制代码<br></code></pre></td></tr></table></figure>

<ul>
<li>在<strong>单体应用</strong>下，我们将三个功能的代码写到一个系统，而且都是连接同一数据库，这样的话很容易就能控制事务，若其中一个失败，则整个事务都会回滚。</li>
<li>而在<strong>分布式系统</strong>下，我们拆分了很多的微服务，它们都是独立部署且每个服务都有自己操作的数据库，那这样我们想要完成整个下单逻辑，我们就要远程调用这三个机器的各个方法。</li>
<li>但是，由于分布式系统会<strong>经常出现</strong>机器宕机、网络异常、消息丢失、消息乱序、数据错误、不可靠的 TCP、存储数据丢失…等<strong>异常情况</strong>。所以，<strong>分布式事务</strong>是企业集成中的一个技术难点，也是每一个分布式系统架构中都会涉及到的一个东西，特别是在微服务架构中，几乎可以说是<strong>无法避免</strong>。</li>
</ul>
<h2 id="三、相关概述及理论"><a href="#三、相关概述及理论" class="headerlink" title="三、相关概述及理论"></a>三、相关概述及理论</h2><h3 id="3-1-CAP理论"><a href="#3-1-CAP理论" class="headerlink" title="3.1 CAP理论"></a>3.1 CAP理论</h3><blockquote>
<p><code>CAP</code> 指的是一致性（Consistency）、可用性（Availability）、分区容错性（Partition tolerance）。</p>
<p><code>CAP</code> 原则指的是，这三个要素<strong>最多</strong>只能<strong>同时实现两点</strong>，<strong>不可能三者兼顾</strong>。</p>
</blockquote>
<ul>
<li><strong>示意图</strong>：</li>
</ul>
<p><img src="https://picgo-liziyuan.oss-cn-hangzhou.aliyuncs.com/img202208082203402.webp" srcset="/img/loading.gif" lazyload alt="image-20220709071207113"></p>
<ul>
<li><p>一致性</p>
<p>（Consistency）：</p>
<ul>
<li>在分布式系统中的<strong>所有数据备份</strong>，在<strong>同一时刻</strong>是否<strong>同样的值</strong>。（等同于所有节点访问同一份最新的数据副本）。</li>
<li>比如我们有三个节点，当我给节点1保存了值，那么我再请求节点2、3的数据时，响应的数据也应该是这个最新的值。</li>
</ul>
</li>
<li><p>可用性</p>
<p>（Availability） ：</p>
<ul>
<li>在集群中一<strong>部分节点故障</strong>后，集群<strong>整体是否还能响应</strong>客户端的读写请求。（对数据更新具备高可用性）。</li>
</ul>
</li>
<li><p>分区容错性</p>
<p>（Partition Tolerance） ：</p>
<ul>
<li>大多数分布式系统都分布在多个子网络。每个子网络就叫做一个区（partition）。分区容错的意思是<strong>区间通信可能失败</strong>。比如，一台服务器放在中国，另一台服务器放在美国，这就是两个区，它们之间可能无法通信。</li>
</ul>
</li>
</ul>
<h3 id="3-2-CAP为什么不能三者兼顾？"><a href="#3-2-CAP为什么不能三者兼顾？" class="headerlink" title="3.2 CAP为什么不能三者兼顾？"></a>3.2 CAP为什么不能三者兼顾？</h3><ul>
<li><strong>满足一致性</strong>：假设我们有三个节点，当客户端有一个请求进来，我们所有的节点完成数据备份，此时满足了我们的一致性<code>C</code>的需求。</li>
<li><strong>可用性与一致性冲突</strong>：再次假设，当节点1向节点2、3要求同步备份数据时，此时节点3发生了网络故障，也就是分区容错性。接下来我们就会考虑，能否<strong>满足可用性</strong>？若让其满足的话（允许客户端请求负载到节点3读取数据），但是由于上次发生故障导致节点3的数据没有更新，则此时<strong>读到的数据</strong>就出现了<strong>不一致</strong>。所以当你想要满足一致性，就必须让节点3不能被访问，既然不能被访问相当于又不可用。**<code>C</code>和<code>A</code>无法同时做到**。</li>
<li>在<strong>分布式系统</strong>里，因为我们这个<strong>网络肯定会出现问题</strong>，所以我们<strong>永远都要满足分区容错</strong>。则就需要在一致性与可用性做出选择。</li>
<li>选择可用性+分区容错性（<code>AP</code>）的情况下，我们不去在意读到的数据是否一致，这种场景实现相对简单。</li>
<li>若选择一致性+分区容错性（<code>CP</code>）的情况下，是如何保证它们之间一致的？我们在分布式系统里边一般会有一些<strong>一致性算法</strong>，典型的代表，比如说Google的Chubby分布式锁服务，采用了<code>Paxos</code>算法；etcd分布式键值数据库，采用了<code>Raft</code>算法；ZooKeeper分布式应用协调服务，Chubby的开源实现，采用<code>ZAB</code>算法。</li>
</ul>
<h3 id="3-3-Raft算法实现分布式系统一致性"><a href="#3-3-Raft算法实现分布式系统一致性" class="headerlink" title="3.3 Raft算法实现分布式系统一致性"></a>3.3 Raft算法实现分布式系统一致性</h3><ul>
<li>由于 <code>Paxos</code> 算法过于晦涩难懂且难以实现，后提出了一种更<strong>易于理解</strong>和实现并能等价于 <code>Paxos</code> 算法<strong>的共识算法</strong> - <code>Raft </code>算法。</li>
<li><code>Raft</code> 算法有<strong>两个核心概念</strong>：<ul>
<li><strong>领导选举</strong>（关注角色、心跳时间、自旋时间）-&gt; <a href="https://link.juejin.cn/?target=https://acehi.github.io/thesecretlivesofdata-cn/raft/%23election">Leader的选举过程-演示动画</a>：<a href="https://link.juejin.cn/?target=https://acehi.github.io/thesecretlivesofdata-cn/raft/%23election">acehi.github.io&#x2F;thesecretli…</a></li>
<li><strong>日志复制</strong> -&gt; <a href="https://link.juejin.cn/?target=https://acehi.github.io/thesecretlivesofdata-cn/raft/%23replication">日志复制过程-演示动画</a>：<a href="https://link.juejin.cn/?target=https://acehi.github.io/thesecretlivesofdata-cn/raft/%23replication">acehi.github.io&#x2F;thesecretli…</a></li>
</ul>
</li>
<li>通过它们来保证我们整个集群的一致性，即使有分区错误，我们也能保持一致性。</li>
</ul>
<h3 id="3-4-Base理论"><a href="#3-4-Base理论" class="headerlink" title="3.4 Base理论"></a>3.4 Base理论</h3><blockquote>
<p>是对 <code>CAP</code> 理论的延伸，思想是即使无法做到强一致性（<code>CAP</code> 的一致性就是强一致性），但可以采用适当的采取弱一致性，即<strong>最终一致性</strong>。</p>
</blockquote>
<ul>
<li>强一致与弱一致是<strong>对立</strong>概念。<strong>强一致性</strong>也叫做<strong>线性一致性</strong>，除此以外，所有其它的一致性都是弱一致性的特殊情况。所谓强一致性，即数据备份是<strong>同步</strong>的，<strong>弱一致性</strong>，即数据备份是<strong>异步</strong>的。</li>
<li><strong>基本可用</strong>（Basically Available）：指分布式系统在出现故障的时候，<strong>允许损失部分可用性</strong>（例如响应时间、功能上的可用性）。需要注意的是，基本可用绝<strong>不等价于系统不可用</strong>。就比如：<ul>
<li><strong>响应时间上的损失</strong>：正常情况下搜索引擎需要在 0.5 秒之内返回给用户相应的查询结果，但由于出现故障（比如系统部分机房发生断电或断网故障），查询结果的响应时间增加到了 1~2 秒（查询故障节点不行，就换其它机器进行查询，允许查询速度慢一点）。</li>
<li><strong>功能上的损失</strong>：购物网站在购物高峰（如双十一）时，为了保护系统的稳定性，部分消费者可能会被引导到一个降级页面。</li>
</ul>
</li>
<li><strong>软状态</strong>（ Soft State） ：指允许系统存在<strong>中间状态</strong>，而该中间状态不会影响系统整体可用性。分布式存储中一般一份数据会有多个副本，允许不同副本同步的<strong>延时</strong>就是软状态的体现。<code>MySQL Replication</code> 的异步复制也是一种体现。</li>
<li><strong>最终一致性</strong>（ Eventual Consistency）：指系统中的所有数据副本<strong>经过一定时间</strong>后，最终能够<strong>达到一致</strong>的状态。弱一致性和强一致性相反，最终一致性是弱一致性的一种特殊情况。</li>
</ul>
<h2 id="四、常见解决方案"><a href="#四、常见解决方案" class="headerlink" title="四、常见解决方案"></a>四、常见解决方案</h2><h3 id="4-1-2PC-模式"><a href="#4-1-2PC-模式" class="headerlink" title="4.1 2PC 模式"></a>4.1 2PC 模式</h3><blockquote>
<p><code>2PC</code> 就是我们说的<strong>二阶段提交</strong>，又叫做 <code>XA Transactions</code>。<code>MySQL</code> 从 5.5 版本开始支持，<code>SQL Server</code> 2005 开始支持，<code>Oracle</code> 7 开始支持。</p>
</blockquote>
<ul>
<li><strong>示意图</strong>：</li>
</ul>
<p><img src="https://picgo-liziyuan.oss-cn-hangzhou.aliyuncs.com/img202208082203435.webp" srcset="/img/loading.gif" lazyload alt="image-20220709074848470"></p>
<ul>
<li>假设我们这有一个本地资源管理器（相当于每个服务的事务管理器），一个事务管理器（相当于总的事务管理器）。</li>
<li>协调事务处理共为<strong>两个阶段</strong>：<ul>
<li>第一阶段：事务协调器要求每个涉及到事务的数据库<strong>预提交</strong>（<code>PreCommit</code>）此操作，并<strong>反映是否可以提交</strong>。</li>
<li>第二阶段：事务协调器<strong>要求</strong>每个数据库<strong>提交数据</strong>。</li>
<li>其中，如果有<strong>任何一个</strong>数据库<strong>否决</strong>此次提交，那么所有数据库都会被要求<strong>回滚</strong>它们在此事务中的那部分信息。</li>
</ul>
</li>
<li><strong>优点</strong>：<ul>
<li><code>XA 协议</code>比较<strong>简单</strong>，而且一旦商业数据库实现了 <code>XA 协议</code>，使用分布式事务的成本也比较低。</li>
</ul>
</li>
<li><strong>缺点</strong>：<ul>
<li><strong>性能不理想</strong>，特别是在交易下单链路，往往并发量很高，无法满足高并发场景。</li>
<li>目前在商业数据库支持的比较理想，在 <strong>mysql 数据库中支持的不太理想</strong>，<code>mysql</code> 的 <code>XA</code> 实现，没有记录 prepare 阶段日志，主备切换回导致主库与备库数据不一致。</li>
<li>许多 <code>nosql</code> 也没有支持 <code>XA</code>，这让 <code>XA</code> 的<strong>应用场景</strong>变得<strong>非常狭隘</strong>。</li>
</ul>
</li>
<li><strong>总结</strong>：了解即可，使用场景非常少。</li>
</ul>
<h3 id="4-2-3PC-模式"><a href="#4-2-3PC-模式" class="headerlink" title="4.2 3PC 模式"></a>4.2 3PC 模式</h3><blockquote>
<p>三阶段提交（<code>3PC</code>）是二阶段提交（<code>2PC</code>）的一个<strong>改良版本</strong>，引入了两个新的特性。</p>
</blockquote>
<ul>
<li>协调者和参与者均<strong>引入超时机制</strong>，通过超时机制来解决 <code>2PC</code> 的同步阻塞问题，<strong>避免事务</strong>资源<strong>被永久锁定</strong>。</li>
<li>把二阶段演变为三阶段，二阶段提交协议中的第一阶段”准备阶段”一分为二，形成了新的 <code>CanCommit</code>、<code>PreCommit</code>、<code>DoCommit</code> 三个阶段组成事务处理协议。</li>
<li><strong>优点</strong>：<code>3PC</code> 相比较于 <code>2PC</code> 最大的优点就是<strong>降低了参与者的阻塞范围</strong>，并且能够在协调者出现<strong>单点故障后继续达成一致</strong>。</li>
<li><strong>缺点</strong>：虽然通过超时机制解决了资源永久阻塞的问题，但是 <code>3PC</code> <strong>依然存在数据不一致的问题</strong>。当参与者接收到 <code>PreCommit</code> 消息后，如果网络出现分区，此时协调者与参与者无法进行正常通信，这种情况下，参与者依然会进行事务的提交。</li>
<li><strong>总结</strong>：通过了解 <code>2PC</code> 和 <code>3PC</code> 之后，我们可以知道这<strong>两种方案都无法彻底解决分布式下的数据一致性</strong>。</li>
</ul>
<h3 id="4-3-柔性事务-TCC-事务补偿方案"><a href="#4-3-柔性事务-TCC-事务补偿方案" class="headerlink" title="4.3 柔性事务-TCC 事务补偿方案"></a>4.3 柔性事务-TCC 事务补偿方案</h3><blockquote>
<p>补偿事务<code>TCC</code>，全称<code>Try-Confirm-Cancel</code>。</p>
</blockquote>
<ul>
<li><strong>什么是柔性事务</strong>？<ul>
<li>刚性事务：遵循 <code>ACID</code> 原则，强一致性。</li>
<li>柔性事务：遵循 <code>BASE</code> 理论，最终一致性。与刚性事务不同，柔性事务<strong>允许一定时间</strong>内，不同节点的数据<strong>不一致</strong>，<strong>但要求最终一致</strong>。</li>
</ul>
</li>
<li><strong>TCC核心思想</strong>：针对每个操作都要注册一个与其对应的确认（<code>Try</code>）和补偿（<code>Cancel</code>）。<ul>
<li><strong>Try阶段</strong>：做一些<strong>业务检查</strong>以及一些资源预留，它需要后续的<code>Confirm</code>一起才能构成一个完成的业务逻辑。</li>
<li><strong>Comfirm阶段</strong>：<strong>确认提交</strong>，<code>Try</code> 阶段所有分支事务执行成功后开始执行 <code>Confirm</code> 。</li>
<li><strong>Cancel阶段</strong>：业务执行出错需要<strong>回滚</strong>。</li>
</ul>
</li>
<li><strong>示意图</strong>：</li>
</ul>
<p><img src="https://picgo-liziyuan.oss-cn-hangzhou.aliyuncs.com/img202208082203449.webp" srcset="/img/loading.gif" lazyload alt="image-20220709082734127"></p>
<ul>
<li><p>总结</p>
<p>：</p>
<ul>
<li><code>2PC</code> 通常是在跨库<code>DB</code>里，而 <code>TCC</code> 是在<strong>应用层</strong>面。</li>
<li><code>TCC</code> 每个业务逻辑代码都要实现<code>Try</code>、<code>Confirm</code>、<code>Cacnel</code>接口，<strong>开发难度大</strong>，所以所对<strong>应用的倾入性非常强</strong>。</li>
</ul>
</li>
</ul>
<h3 id="4-4-柔性事务-最大努力通知方案"><a href="#4-4-柔性事务-最大努力通知方案" class="headerlink" title="4.4 柔性事务-最大努力通知方案"></a>4.4 柔性事务-最大努力通知方案</h3><blockquote>
<p>方案主要用在<strong>与第三方系统通讯</strong>时，比如：调用微信或支付宝支付后的支付结果通知。这种 方案也是结合 <code>MQ</code> 进行实现，例如：通过 <code>MQ</code> 发送 <code>http</code> 请求，<strong>设置最大通知次数</strong>，<strong>达到通知次数后即不再通知</strong>。</p>
</blockquote>
<ul>
<li><strong>应用场景</strong>：银行通知、商户通知等（各大交易业务平台间的商户通知：多次通知、查询校对、对 账文件），支付宝的支付成功异步回调。</li>
<li><strong>案例说明</strong>：我们现在有一个大业务，调用了积分、库存和订单业务。当订单和库存都执行结束，但是在做用户积分扣减时<strong>失败</strong>了，然后订单模块就会<strong>发送一条消息</strong>给 <code>MQ</code>。接下来由订阅了消息队列的订单及库存服务接收消息，当它们都<strong>收到消息后</strong>，库存服务就会解锁库存，订单服务就会解锁订单，<strong>完成事务的回滚</strong>。既然是最大努力通知，期间就会<strong>不断发送</strong>业务处理失败的消息，<strong>直至</strong>对应业务<strong>返回处理成功</strong>的消息，<strong>就不再进行通知</strong>了。</li>
</ul>
<h3 id="4-5-柔性事务-可靠消息-最终一致性方案（异步确保型）"><a href="#4-5-柔性事务-可靠消息-最终一致性方案（异步确保型）" class="headerlink" title="4.5 柔性事务-可靠消息+最终一致性方案（异步确保型）"></a>4.5 柔性事务-可靠消息+最终一致性方案（异步确保型）</h3><ul>
<li><strong>实现</strong>：业务处理服务在业务事务提交之前，向实时消息服务请求发送消息，<strong>实时消息服务只记录消息数据</strong>，而不是真正的发送。业务处理服务在<strong>业务事务提交之后</strong>，向实时消息服务<strong>确认发送</strong>。只有在得到确认发送指令后，实时消息服务<strong>才会真正发送</strong>。</li>
<li><strong>关键点</strong>（防止消息丢失）：<ul>
<li>做好消息确认机制 <code>Publisher</code>，<code>Consumer</code> 手动 <code>ack</code>。</li>
<li>每一个发送的消息都在数据库做好记录，定期将失败的消息再次发送一遍。</li>
</ul>
</li>
<li><strong>消息记录表</strong>：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `mq_message` (<br>	`message_id` <span class="hljs-type">CHAR</span> ( <span class="hljs-number">32</span> ) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>	`content` text,<br>	`to_exchane` <span class="hljs-type">VARCHAR</span> ( <span class="hljs-number">255</span> ) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>	`routing_key` <span class="hljs-type">VARCHAR</span> ( <span class="hljs-number">255</span> ) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>	`class_type` <span class="hljs-type">VARCHAR</span> ( <span class="hljs-number">255</span> ) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>	`message_status` <span class="hljs-type">INT</span> ( <span class="hljs-number">1</span> ) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;0-新建 1-已发送 2-错误抵达 3-已抵达&#x27;</span>,<br>	`create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>	`update_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br><span class="hljs-keyword">PRIMARY</span> KEY ( `message_id` ) <br>) ENGINE <span class="hljs-operator">=</span> INNODB <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8mb4<br>复制代码<br></code></pre></td></tr></table></figure>

<h2 id="五、分布式事务框架-Seata"><a href="#五、分布式事务框架-Seata" class="headerlink" title="五、分布式事务框架-Seata"></a>五、分布式事务框架-Seata</h2><blockquote>
<p><code>Seata</code> 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。<code>Seata</code> 将为用户提供了 <code>AT</code>、<code>TCC</code>、<code>SAGA</code> 和 <code>XA</code> 事务模式，为用户打造一站式的分布式解决方案。</p>
</blockquote>
<h3 id="5-1-核心概念及原理"><a href="#5-1-核心概念及原理" class="headerlink" title="5.1 核心概念及原理"></a>5.1 核心概念及原理</h3><ul>
<li>TC - 事务协调者：维护全局和分支事务的状态，<strong>驱动</strong>全局事务<strong>提交或回滚</strong>。</li>
<li>TM - 事务管理器：<strong>定义全局</strong>事务的<strong>范围</strong>（开始全局事务、提交或回滚全局事务）。</li>
<li>RM - 资源管理器：<strong>管理分支</strong>事务处理的<strong>资源</strong>，与 TC 交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</li>
<li><strong>工作原理</strong>：</li>
</ul>
<p><img src="https://picgo-liziyuan.oss-cn-hangzhou.aliyuncs.com/img202208082203454.webp" srcset="/img/loading.gif" lazyload alt="image-20220709125044911"></p>
<ul>
<li><p>流程描述</p>
<p>：</p>
<ul>
<li>假设我们现在要执行一个大的下单业务 Business，<strong>大业务</strong>的 <code>TM</code>（事务管理器）先会告诉 <code>TC</code>（事务协调者）它要准备跨服<strong>开启</strong>一个<strong>全局事务</strong>。</li>
<li>开始全局事务后，接下来它调用第一个微服务的事务方法的时候，Storage 服务就会在 <code>TC</code>（事务协调者）<strong>注册</strong>一下，我们称为<strong>分支事务</strong>。相当于它的 <code>RM</code>（资源管理器）会告诉 <code>TC</code>（事务协调者），它有一个分支事务，并且它要实时<strong>汇报</strong>它的<strong>事务状态</strong>，它这个分支是提交成功还是失败回滚， <code>TC</code>（事务协调者）都能实时的知道。</li>
<li>接下来调我们第二个远程服务 Order，及第三个远程服务 Account也是同理注册分支事务，并且实时汇报状态。</li>
<li><strong>大事务只要一开启</strong>，每调一个小事务，<code>TC</code>（事务协调者）<strong>都知道</strong>这个<strong>小事务成了还是败了</strong>。</li>
<li>假设其中最后一个分支事务失败了，需要进行回滚。这个时候，<code>TC</code>（事务协调者）知道我们的大事务，已经调成功两个了，并且前两个事务都已经提交了，但是第三个事务给回滚了，<code>TC</code>（事务协调者）就会<strong>命令前两个事务也回滚</strong>。</li>
</ul>
</li>
</ul>
<h3 id="5-2-AT模式"><a href="#5-2-AT模式" class="headerlink" title="5.2 AT模式"></a>5.2 AT模式</h3><p><strong>5.2.1 相关概念</strong>：</p>
<ul>
<li><code>AT</code>模式（自动事务Auto Transaction）是<code>Seata</code>最<strong>主推的</strong>分布式事务解决方案，它是基于<code>XA</code>演进而来。</li>
<li><code>AT</code> 模式是一种<strong>无侵入</strong>的分布式事务解决方案，也就是说我们<strong>不需要再编写多余的代码来实现</strong>这个模式，<strong>只需要</strong>在方法中<strong>添加上指定的注解</strong>即可。</li>
<li>在 AT 模式下，用户只需关注自己的“业务 <code>SQL</code>”，用户的 “业务 <code>SQL</code>” 作为一阶段，<code>Seata</code> 框架会<strong>自动生成</strong>事务的<strong>二阶段提交和回滚</strong>操作。</li>
<li>AT模式支持的数据库有：<code>MySQL</code>、<code>Oracle</code>、<code>PostgreSQL</code>和 <code>TiDB</code>。</li>
</ul>
<p><strong>5.2.2 模式概述</strong>：</p>
<ul>
<li><p><strong>前提</strong>：我们如果要使用该模式，那么<strong>每一个</strong>要使用分布式事务的<strong>数据库</strong>都需要一个 <code>UNDO_LOG</code> 表（即回滚日志表）。</p>
</li>
<li><p><strong>效果</strong>：该模式下 <code>TC</code>（事务协调者） 只要调分支事务，<strong>成功</strong>之后就会<strong>提交事务</strong>，但是如果有一个分支事务<strong>失败</strong>了，失败的这个可以<strong>自己进行回滚</strong>。</p>
</li>
<li><p>处理逻辑</p>
<p>：</p>
<ul>
<li>某个服务除了它常规的业务表以外，我们会额外去创建一个回滚日志表。它是在<code>RM</code>（资源管理器）部分完成的，会在<strong>每一个数据库单元处理时</strong>均会生成一条<code>log</code>数据。</li>
<li>对于已提交的事务要进行回滚，它会利用<strong>魔改数据库进行反向补偿</strong>。比如：我们这有条加二的记录，原来它的值是八，加二以后变成十，结果被人给回滚了。</li>
<li>它先在 <code>UNDO_LOG</code> 里面记录了一下这条<strong>记录没改变之前的值</strong>。如果它失败回滚了，那它就回过头把我们数据库里边的这个十再改回去，改成八。所以，它相当于在我们事务执行之前，它先读取一下这个状态是几，最后再改回来。</li>
</ul>
</li>
</ul>
<h3 id="5-3-Seata-服务搭建"><a href="#5-3-Seata-服务搭建" class="headerlink" title="5.3 Seata 服务搭建"></a>5.3 Seata 服务搭建</h3><p><strong>5.3.1 组件版本关系</strong>：</p>
<blockquote>
<p>每个 <code>Spring Cloud Alibaba</code> 版本及其自身所适配的各组件对应版本如下表所示（<strong>避免版本不兼容</strong>带来未知问题）。</p>
</blockquote>
<p><img src="https://picgo-liziyuan.oss-cn-hangzhou.aliyuncs.com/img202208082203640.webp" srcset="/img/loading.gif" lazyload alt="image-20220708081609199"></p>
<p><strong>5.3.2 Docker下安装 Seata</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">1.下载镜像（注意：此处版本号请参考组件版本关系图！）。</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker pull seataio/seata-server:1.2.0</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">2.启动容器。</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d --name seata-server -p 8091:8091 seataio/seata-server:1.2.0</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">3.创建存放配置的文件夹。</span><br>mkdir -p /home/seata/config<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">4.拷贝配置文件。</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker <span class="hljs-built_in">cp</span> seata-server:/seata-server/resources /home/seata/config</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">5.编辑配置文件（参考下面截图）。</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> /home/seata/config/resources</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">vim registry.conf</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">提示：</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">可以在registry.conf指定seata配置的位置（config &#123;<span class="hljs-built_in">type</span> = <span class="hljs-string">&quot;nacos&quot;</span>&#125;）。</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">可以在file.conf中指定事务日志存储类型（store &#123;mode = <span class="hljs-string">&quot;db&quot;</span>&#125;），若使用mysql-8版本则需要额外修改以下两项配置，否则报错。</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">driverClassName = <span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">url = <span class="hljs-string">&quot;jdbc:mysql://127.0.0.1:3306/seata?serverTimezone=UTC&quot;</span></span><br>复制代码<br></code></pre></td></tr></table></figure>

<p><img src="https://picgo-liziyuan.oss-cn-hangzhou.aliyuncs.com/img202208082203629.webp" srcset="/img/loading.gif" lazyload alt="image-20220708100915057"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">6.停止容器。</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker stop seata-server</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">7.移除旧容器。</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker <span class="hljs-built_in">rm</span> seata-server</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">8.启动新容器并挂载配置。</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker run -d \</span><br><span class="language-bash">--name seata-server \</span><br><span class="language-bash">-p 8091:8091 \</span><br><span class="language-bash">-e SEATA_IP=yourIp（公网IP） \</span><br><span class="language-bash">-v /home/seata/config/resources:/seata-server/resources \</span><br><span class="language-bash">seataio/seata-server:1.2.0</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置开机自启。</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker update seata-server --restart=always</span><br>复制代码<br></code></pre></td></tr></table></figure>

<p><strong>5.3.3 验证Seata服务启动成功</strong>：</p>
<ul>
<li>查看容器日志（Server started …）：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">docker logs seata-server</span><br>复制代码<br></code></pre></td></tr></table></figure>

<ul>
<li>访问注册中心后台（成功注册）：</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs txt">http://yourIp:8848/nacos<br>复制代码<br></code></pre></td></tr></table></figure>

<p><img src="https://picgo-liziyuan.oss-cn-hangzhou.aliyuncs.com/img202208082203674.webp" srcset="/img/loading.gif" lazyload alt="image-20220708101405016"></p>
<h3 id="5-4-项目整合"><a href="#5-4-项目整合" class="headerlink" title="5.4 项目整合"></a>5.4 项目整合</h3><p><strong>5.4.1 数据库添加 UNDO_LOG 表</strong>：</p>
<blockquote>
<p>每一个要使用分布式事务的数据库都需要一个 <code>UNDO_LOG</code> 表。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `undo_log` (<br>	`id` <span class="hljs-type">BIGINT</span> ( <span class="hljs-number">20</span> ) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>	`branch_id` <span class="hljs-type">BIGINT</span> ( <span class="hljs-number">20</span> ) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>	`xid` <span class="hljs-type">VARCHAR</span> ( <span class="hljs-number">100</span> ) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>	`context` <span class="hljs-type">VARCHAR</span> ( <span class="hljs-number">128</span> ) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>	`rollback_info` LONGBLOB <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>	`log_status` <span class="hljs-type">INT</span> ( <span class="hljs-number">11</span> ) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>	`log_created` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>	`log_modified` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>	`ext` <span class="hljs-type">VARCHAR</span> ( <span class="hljs-number">100</span> ) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>	<span class="hljs-keyword">PRIMARY</span> KEY ( `id` ),<br><span class="hljs-keyword">UNIQUE</span> KEY `ux_undo_log` ( `xid`, `branch_id` ) <br>) ENGINE <span class="hljs-operator">=</span> INNODB AUTO_INCREMENT <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8;<br>复制代码<br></code></pre></td></tr></table></figure>

<ul>
<li><code>branch_id</code>：分支事务ID。</li>
<li><code>xid</code>：全局事务ID（<code>Seata</code> 服务端地址+ ID）。</li>
<li><code>context</code>：回滚信息序列化和压缩格式。</li>
<li><code>rollback_info</code>：回滚信息。</li>
<li><code>log_status</code>：日志状态（<code>0</code>表示正常，<code>1</code>表示全局已完成）。</li>
<li><code>log_created</code>：创建时间。</li>
<li><code>log_modified</code>：修改时间。</li>
</ul>
<p><strong>5.4.2 依赖引入</strong>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml">        <span class="hljs-comment">&lt;!--需要分布式事务的服务引入 seata-starter--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>复制代码<br></code></pre></td></tr></table></figure>

<p><strong>5.4.3 配置代理数据源</strong>：</p>
<blockquote>
<p>配置代理数据源实现分支事务，如果没有注入，事务无法成功回滚。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySeataConfig</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    DataSourceProperties dataSourceProperties;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 需要将 DataSourceProxy 设置为主数据源，否则事务无法回滚。</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dataSourceProperties 数据源属性配置。</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@link</span> DataSource&#125;</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">(DataSourceProperties dataSourceProperties)</span> &#123;<br><br>        <span class="hljs-type">HikariDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> dataSourceProperties.initializeDataSourceBuilder()<br>                .type(HikariDataSource.class).build();<br><br>        <span class="hljs-keyword">if</span> (StringUtils.hasText(dataSourceProperties.getName())) &#123;<br>            dataSource.setPoolName(dataSourceProperties.getName());<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceProxy</span>(dataSource);<br>    &#125;<br><br>&#125;<br>复制代码<br></code></pre></td></tr></table></figure>

<p><strong>5.4.4 微服务中添加配置文件</strong>：</p>
<blockquote>
<p><strong>方式一</strong>（此处使用）：<strong>每个</strong>要使用分布式事务的<strong>微服务</strong>服务中（<code>src/main/resources/</code>），都要添加这两个文件（<code>registry.conf</code>、<code>file.conf</code>）。</p>
<p><strong>方式二</strong>：也可以将 <code>Nacos</code> 作为统一配置中心，去配置 <code>Seata</code> 的 <code>file.conf</code> 各项参数，实现集群的配置共享，并结合 <code>application.properties/yml</code> + <code>registry.conf</code> 完成微服务整合。</p>
</blockquote>
<ul>
<li><code>registry.conf</code></li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># ---注册中心配置---</span><br><span class="hljs-attr">registry</span> <span class="hljs-string">&#123;</span><br><span class="hljs-comment">  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span><br><span class="hljs-comment">  # 指定类型为nacos注册中心（根据项目所使用的注册中心进行选择），默认是&quot;file&quot;。</span><br>  <span class="hljs-attr">type</span> = <span class="hljs-string">&quot;nacos&quot;</span><br><br>  <span class="hljs-attr">nacos</span> <span class="hljs-string">&#123;</span><br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;localhost:8848&quot;</span><br>    <span class="hljs-attr">namespace</span> = <span class="hljs-string">&quot;public&quot;</span><br>    <span class="hljs-attr">cluster</span> = <span class="hljs-string">&quot;default&quot;</span><br>  <span class="hljs-attr">&#125;</span><br>  <span class="hljs-attr">eureka</span> <span class="hljs-string">&#123;</span><br>    <span class="hljs-attr">serviceUrl</span> = <span class="hljs-string">&quot;http://localhost:1001/eureka&quot;</span><br>    <span class="hljs-attr">application</span> = <span class="hljs-string">&quot;default&quot;</span><br>    <span class="hljs-attr">weight</span> = <span class="hljs-string">&quot;1&quot;</span><br>  <span class="hljs-attr">&#125;</span><br>  <span class="hljs-attr">redis</span> <span class="hljs-string">&#123;</span><br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;localhost:6379&quot;</span><br>    <span class="hljs-attr">db</span> = <span class="hljs-string">&quot;0&quot;</span><br>  <span class="hljs-attr">&#125;</span><br>  <span class="hljs-attr">zk</span> <span class="hljs-string">&#123;</span><br>    <span class="hljs-attr">cluster</span> = <span class="hljs-string">&quot;default&quot;</span><br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;127.0.0.1:2181&quot;</span><br>    <span class="hljs-attr">session.timeout</span> = <span class="hljs-string">6000</span><br>    <span class="hljs-attr">connect.timeout</span> = <span class="hljs-string">2000</span><br>  <span class="hljs-attr">&#125;</span><br>  <span class="hljs-attr">consul</span> <span class="hljs-string">&#123;</span><br>    <span class="hljs-attr">cluster</span> = <span class="hljs-string">&quot;default&quot;</span><br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;127.0.0.1:8500&quot;</span><br>  <span class="hljs-attr">&#125;</span><br>  <span class="hljs-attr">etcd3</span> <span class="hljs-string">&#123;</span><br>    <span class="hljs-attr">cluster</span> = <span class="hljs-string">&quot;default&quot;</span><br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;http://localhost:2379&quot;</span><br>  <span class="hljs-attr">&#125;</span><br>  <span class="hljs-attr">sofa</span> <span class="hljs-string">&#123;</span><br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;127.0.0.1:9603&quot;</span><br>    <span class="hljs-attr">application</span> = <span class="hljs-string">&quot;default&quot;</span><br>    <span class="hljs-attr">region</span> = <span class="hljs-string">&quot;DEFAULT_ZONE&quot;</span><br>    <span class="hljs-attr">datacenter</span> = <span class="hljs-string">&quot;DefaultDataCenter&quot;</span><br>    <span class="hljs-attr">cluster</span> = <span class="hljs-string">&quot;default&quot;</span><br>    <span class="hljs-attr">group</span> = <span class="hljs-string">&quot;SEATA_GROUP&quot;</span><br>    <span class="hljs-attr">addressWaitTime</span> = <span class="hljs-string">&quot;3000&quot;</span><br>  <span class="hljs-attr">&#125;</span><br>  <span class="hljs-attr">file</span> <span class="hljs-string">&#123;</span><br>    <span class="hljs-attr">name</span> = <span class="hljs-string">&quot;file.conf&quot;</span><br>  <span class="hljs-attr">&#125;</span><br><span class="hljs-attr">&#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># ---配置中心---</span><br><span class="hljs-attr">config</span> <span class="hljs-string">&#123;</span><br><span class="hljs-comment">  # file、nacos 、apollo、zk、consul、etcd3</span><br><span class="hljs-comment">  # 指定seata配置的位置，默认&quot;file&quot;。</span><br>  <span class="hljs-attr">type</span> = <span class="hljs-string">&quot;file&quot;</span><br><br>  <span class="hljs-attr">nacos</span> <span class="hljs-string">&#123;</span><br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;localhost&quot;</span><br>    <span class="hljs-attr">namespace</span> = <span class="hljs-string">&quot;public&quot;</span><br>    <span class="hljs-attr">cluster</span> = <span class="hljs-string">&quot;default&quot;</span><br>  <span class="hljs-attr">&#125;</span><br>  <span class="hljs-attr">consul</span> <span class="hljs-string">&#123;</span><br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;127.0.0.1:8500&quot;</span><br>  <span class="hljs-attr">&#125;</span><br>  <span class="hljs-attr">apollo</span> <span class="hljs-string">&#123;</span><br>    <span class="hljs-attr">app.id</span> = <span class="hljs-string">&quot;seata-server&quot;</span><br>    <span class="hljs-attr">apollo.meta</span> = <span class="hljs-string">&quot;http://192.168.1.204:8801&quot;</span><br>  <span class="hljs-attr">&#125;</span><br>  <span class="hljs-attr">zk</span> <span class="hljs-string">&#123;</span><br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;127.0.0.1:2181&quot;</span><br>    <span class="hljs-attr">session.timeout</span> = <span class="hljs-string">6000</span><br>    <span class="hljs-attr">connect.timeout</span> = <span class="hljs-string">2000</span><br>  <span class="hljs-attr">&#125;</span><br>  <span class="hljs-attr">etcd3</span> <span class="hljs-string">&#123;</span><br>    <span class="hljs-attr">serverAddr</span> = <span class="hljs-string">&quot;http://localhost:2379&quot;</span><br>  <span class="hljs-attr">&#125;</span><br>  <span class="hljs-attr">file</span> <span class="hljs-string">&#123;</span><br><span class="hljs-comment">    # 关联 `file.conf` 文件中配置的seata参数。</span><br>    <span class="hljs-attr">name</span> = <span class="hljs-string">&quot;file.conf&quot;</span><br>  <span class="hljs-attr">&#125;</span><br><span class="hljs-attr">&#125;</span><br><span class="hljs-attr">复制代码</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>file.conf</code></li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># ---网络传输配置---</span><br><span class="hljs-attr">transport</span> <span class="hljs-string">&#123;</span><br><span class="hljs-comment">  # tcp udt unix-domain-socket</span><br>  <span class="hljs-attr">type</span> = <span class="hljs-string">&quot;TCP&quot;</span><br><span class="hljs-comment">  #NIO NATIVE</span><br>  <span class="hljs-attr">server</span> = <span class="hljs-string">&quot;NIO&quot;</span><br><span class="hljs-comment">  #enable heartbeat</span><br>  <span class="hljs-attr">heartbeat</span> = <span class="hljs-string">true</span><br><span class="hljs-comment">  #thread factory for netty</span><br>  <span class="hljs-attr">thread-factory</span> <span class="hljs-string">&#123;</span><br>    <span class="hljs-attr">boss-thread-prefix</span> = <span class="hljs-string">&quot;NettyBoss&quot;</span><br>    <span class="hljs-attr">worker-thread-prefix</span> = <span class="hljs-string">&quot;NettyServerNIOWorker&quot;</span><br>    <span class="hljs-attr">server-executor-thread-prefix</span> = <span class="hljs-string">&quot;NettyServerBizHandler&quot;</span><br>    <span class="hljs-attr">share-boss-worker</span> = <span class="hljs-string">false</span><br>    <span class="hljs-attr">client-selector-thread-prefix</span> = <span class="hljs-string">&quot;NettyClientSelector&quot;</span><br>    <span class="hljs-attr">client-selector-thread-size</span> = <span class="hljs-string">1</span><br>    <span class="hljs-attr">client-worker-thread-prefix</span> = <span class="hljs-string">&quot;NettyClientWorkerThread&quot;</span><br><span class="hljs-comment">    # netty boss thread size,will not be used for UDT</span><br>    <span class="hljs-attr">boss-thread-size</span> = <span class="hljs-string">1</span><br><span class="hljs-comment">    #auto default pin or 8</span><br>    <span class="hljs-attr">worker-thread-size</span> = <span class="hljs-string">8</span><br>  <span class="hljs-attr">&#125;</span><br>  <span class="hljs-attr">shutdown</span> <span class="hljs-string">&#123;</span><br><span class="hljs-comment">    # when destroy server, wait seconds</span><br>    <span class="hljs-attr">wait</span> = <span class="hljs-string">3</span><br>  <span class="hljs-attr">&#125;</span><br>  <span class="hljs-attr">serialization</span> = <span class="hljs-string">&quot;seata&quot;</span><br>  <span class="hljs-attr">compressor</span> = <span class="hljs-string">&quot;none&quot;</span><br><span class="hljs-attr">&#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># ---当前微服务在seata服务器中注册的信息配置---</span><br><span class="hljs-attr">service</span> <span class="hljs-string">&#123;</span><br><span class="hljs-comment">  # 事务分组，默认：$&#123;spring.applicaiton.name&#125;-fescar-service-group。</span><br>  <span class="hljs-attr">vgroup_mapping.applicaiton-name-fescar-service-group</span> = <span class="hljs-string">&quot;default&quot;</span><br><span class="hljs-comment">  # 仅支持单节点，不要配置多地址，这里的default要和事务分组的值一致。</span><br>  <span class="hljs-attr">default.grouplist</span> = <span class="hljs-string">&quot;127.0.0.1:8091&quot;</span><br><span class="hljs-comment">  # 降级，当前不支持。</span><br>  <span class="hljs-attr">enableDegrade</span> = <span class="hljs-string">false</span><br><span class="hljs-comment">  # 禁用全局事务。</span><br>  <span class="hljs-attr">disable</span> = <span class="hljs-string">false</span><br><span class="hljs-comment">  #unit ms,s,m,h,d represents milliseconds, seconds, minutes, hours, days, default permanent</span><br>  <span class="hljs-attr">max.commit.retry.timeout</span> = <span class="hljs-string">&quot;-1&quot;</span><br>  <span class="hljs-attr">max.rollback.retry.timeout</span> = <span class="hljs-string">&quot;-1&quot;</span><br><span class="hljs-attr">&#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># ---客户端相关工作的机制---</span><br><span class="hljs-attr">client</span> <span class="hljs-string">&#123;</span><br>  <span class="hljs-attr">async.commit.buffer.limit</span> = <span class="hljs-string">10000</span><br>  <span class="hljs-attr">lock</span> <span class="hljs-string">&#123;</span><br>    <span class="hljs-attr">retry.internal</span> = <span class="hljs-string">10</span><br>    <span class="hljs-attr">retry.times</span> = <span class="hljs-string">30</span><br>  <span class="hljs-attr">&#125;</span><br>  <span class="hljs-attr">report.retry.count</span> = <span class="hljs-string">5</span><br><span class="hljs-attr">&#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># ---事务日志存储配置---</span><br><span class="hljs-comment"># 注意：该部分配置仅在seata-server中使用，如果选择db请配合seata.sql使用。</span><br><span class="hljs-comment">## transaction log store </span><br><span class="hljs-attr">store</span> <span class="hljs-string">&#123;</span><br><span class="hljs-comment">  ## store mode: file、db</span><br>  <span class="hljs-attr">mode</span> = <span class="hljs-string">&quot;file&quot;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  ## file store</span><br>  <span class="hljs-attr">file</span> <span class="hljs-string">&#123;</span><br>    <span class="hljs-attr">dir</span> = <span class="hljs-string">&quot;sessionStore&quot;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    # branch session size , if exceeded first try compress lockkey, still exceeded throws exceptions</span><br>    <span class="hljs-attr">max-branch-session-size</span> = <span class="hljs-string">16384</span><br><span class="hljs-comment">    # globe session size , if exceeded throws exceptions</span><br>    <span class="hljs-attr">max-global-session-size</span> = <span class="hljs-string">512</span><br><span class="hljs-comment">    # file buffer size , if exceeded allocate new buffer</span><br>    <span class="hljs-attr">file-write-buffer-cache-size</span> = <span class="hljs-string">16384</span><br><span class="hljs-comment">    # when recover batch read size</span><br>    <span class="hljs-attr">session.reload.read_size</span> = <span class="hljs-string">100</span><br><span class="hljs-comment">    # async, sync</span><br>    <span class="hljs-attr">flush-disk-mode</span> = <span class="hljs-string">async</span><br>  <span class="hljs-attr">&#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  ## database store</span><br>  <span class="hljs-attr">db</span> <span class="hljs-string">&#123;</span><br><span class="hljs-comment">    ## the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp) etc.</span><br>    <span class="hljs-attr">datasource</span> = <span class="hljs-string">&quot;dbcp&quot;</span><br><span class="hljs-comment">    ## mysql/oracle/h2/oceanbase etc.</span><br>    <span class="hljs-attr">db-type</span> = <span class="hljs-string">&quot;mysql&quot;</span><br>    <span class="hljs-attr">url</span> = <span class="hljs-string">&quot;jdbc:mysql://127.0.0.1:3306/seata&quot;</span><br>    <span class="hljs-attr">user</span> = <span class="hljs-string">&quot;mysql&quot;</span><br>    <span class="hljs-attr">password</span> = <span class="hljs-string">&quot;mysql&quot;</span><br>    <span class="hljs-attr">min-conn</span> = <span class="hljs-string">1</span><br>    <span class="hljs-attr">max-conn</span> = <span class="hljs-string">3</span><br>    <span class="hljs-attr">global.table</span> = <span class="hljs-string">&quot;global_table&quot;</span><br>    <span class="hljs-attr">branch.table</span> = <span class="hljs-string">&quot;branch_table&quot;</span><br>    <span class="hljs-attr">lock-table</span> = <span class="hljs-string">&quot;lock_table&quot;</span><br>    <span class="hljs-attr">query-limit</span> = <span class="hljs-string">100</span><br>  <span class="hljs-attr">&#125;</span><br><span class="hljs-attr">&#125;</span><br><span class="hljs-attr">lock</span> <span class="hljs-string">&#123;</span><br><span class="hljs-comment">  ## the lock store mode: local、remote</span><br>  <span class="hljs-attr">mode</span> = <span class="hljs-string">&quot;remote&quot;</span><br><br>  <span class="hljs-attr">local</span> <span class="hljs-string">&#123;</span><br><span class="hljs-comment">    ## store locks in user&#x27;s database</span><br>  <span class="hljs-attr">&#125;</span><br><br>  <span class="hljs-attr">remote</span> <span class="hljs-string">&#123;</span><br><span class="hljs-comment">    ## store locks in the seata&#x27;s server</span><br>  <span class="hljs-attr">&#125;</span><br><span class="hljs-attr">&#125;</span><br><span class="hljs-attr">recovery</span> <span class="hljs-string">&#123;</span><br>  <span class="hljs-attr">committing-retry-delay</span> = <span class="hljs-string">30</span><br>  <span class="hljs-attr">asyn-committing-retry-delay</span> = <span class="hljs-string">30</span><br>  <span class="hljs-attr">rollbacking-retry-delay</span> = <span class="hljs-string">30</span><br>  <span class="hljs-attr">timeout-retry-delay</span> = <span class="hljs-string">30</span><br><span class="hljs-attr">&#125;</span><br><br><span class="hljs-attr">transaction</span> <span class="hljs-string">&#123;</span><br>  <span class="hljs-attr">undo.data.validation</span> = <span class="hljs-string">true</span><br>  <span class="hljs-attr">undo.log.serialization</span> = <span class="hljs-string">&quot;jackson&quot;</span><br><span class="hljs-attr">&#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">## metrics settings</span><br><span class="hljs-attr">metrics</span> <span class="hljs-string">&#123;</span><br>  <span class="hljs-attr">enabled</span> = <span class="hljs-string">false</span><br>  <span class="hljs-attr">registry-type</span> = <span class="hljs-string">&quot;compact&quot;</span><br><span class="hljs-comment">  # multi exporters use comma divided</span><br>  <span class="hljs-attr">exporter-list</span> = <span class="hljs-string">&quot;prometheus&quot;</span><br>  <span class="hljs-attr">exporter-prometheus-port</span> = <span class="hljs-string">9898</span><br><span class="hljs-attr">&#125;</span><br><span class="hljs-attr">复制代码</span><br></code></pre></td></tr></table></figure>

<p><strong>5.4.5 添加全局事务注解</strong>：</p>
<ul>
<li><strong>主业务</strong>方法添加<strong>全局事务</strong>注解：<code>@GlobalTransactional</code></li>
<li><strong>分支业务</strong>方法添加<strong>本地事务</strong>注解：<code>@Transactional</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-meta">@GlobalTransactional</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">purchase</span><span class="hljs-params">(String userId, String commodityCode, <span class="hljs-type">int</span> orderCount)</span> &#123;<br>        ......<br>    &#125;<br>复制代码<br></code></pre></td></tr></table></figure>

<h3 id="5-5-更多官方示例"><a href="#5-5-更多官方示例" class="headerlink" title="5.5 更多官方示例"></a>5.5 更多官方示例</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 整合 nacos</span><br><span class="hljs-attr">https</span>:<span class="hljs-string">//github.com/seata/seata-samples/tree/master/springcloud-nacos-seata</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 整合 jpa</span><br><span class="hljs-attr">https</span>:<span class="hljs-string">//github.com/seata/seata-samples/tree/master/springcloud-jpa-seata</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 整合 dubbo</span><br><span class="hljs-attr">https</span>:<span class="hljs-string">//github.com/seata/seata-samples/tree/master/springboot-dubbo-seata</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 整合 ShardingSphere</span><br><span class="hljs-attr">https</span>:<span class="hljs-string">//github.com/seata/seata-samples/tree/master/springboot-shardingsphere-seata</span><br></code></pre></td></tr></table></figure>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="category-chain-item">微服务</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E4%BA%8B%E5%8A%A1/">#事务</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>分布式事务</div>
      <div>http://example.com/2022/09/04/分布式事务-Seata/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>liziyuan</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年9月4日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/09/04/Swagger/" title="Swagger">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Swagger</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/09/04/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" title="微服务">
                        <span class="hidden-mobile">微服务</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://venom-lemon.github.io/whitehmoob/" target="_blank" rel="nofollow noopener"><span>nav</span></a> <i class="iconfont icon-love"></i> <a target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral">本网站由 <img src="img/you.png" srcset="/img/loading.gif" lazyload width="45px" />提供CDN加速/云存储服务</a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
